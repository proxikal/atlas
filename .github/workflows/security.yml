# Security - Dependency auditing and supply chain verification
#
# Runs on: Cargo.toml/lock changes, daily schedule, manual trigger

name: Security

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
  pull_request:
    paths:
      - '**/Cargo.toml'
      - '**/Cargo.lock'
  workflow_dispatch:

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-audit

      - name: Run audit
        run: cargo audit --deny warnings --json > audit-results.json || true

      - name: Check results
        run: cargo audit --deny warnings

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-audit-results
          path: audit-results.json
          retention-days: 90

      - name: Create issue on vulnerability
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const results = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
              if (results.vulnerabilities?.found) {
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'Security vulnerability detected in dependencies',
                  body: `Security audit found ${results.vulnerabilities.found} vulnerabilities.\n\nRun \`cargo audit\` locally for details.`,
                  labels: ['security', 'dependencies']
                });
              }
            } catch (e) {
              console.log('Could not parse audit results');
            }

  supply-chain:
    name: Supply Chain
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Check all
        run: cargo deny check
